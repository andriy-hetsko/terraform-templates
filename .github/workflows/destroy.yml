name: Destroy Infrastructure (Protected)

on:
    workflow_dispatch:
        inputs:
            password:
                description: "Enter destroy password"
                required: true
                type: string
            bucket_name:
                description: "Terraform Backend S3 Bucket"
                required: true
                type: string
            aws_region:
                description: "AWS Region"
                required: true
                default: "us-east-1"
                type: string
            environment:
                description: "Environment to destroy"
                required: true
                default: "dev"
                type: string
            # cidr:
            #     description: "VPC CIDR block"
            #     required: true
            #     type: string
            #     default: "10.0.0.0/16"

            # azs:
            #     description: "Availability Zones (JSON array)"
            #     required: true
            #     type: string
            #     default: '["us-east-1a","us-east-1b","us-east-1c"]'

            # public_subnets:
            #     description: "Public subnets CIDRs (JSON array)"
            #     required: true
            #     type: string
            #     default: '["10.0.1.0/24","10.0.2.0/24","10.0.3.0/24"]'

            # private_subnets:
            #     description: "Private subnets CIDRs (JSON array)"
            #     required: true
            #     type: string
            #     default: '["10.0.11.0/24","10.0.12.0/24","10.0.13.0/24"]'
jobs:
    destroy:
        runs-on: ubuntu-latest

        env:
            INPUT_PASSWORD: ${{ inputs.password }}
            DESTROY_PASSWORD: ${{ secrets.DESTROY_PASSWORD }}
            BUCKET_NAME_BACKEND: ${{ inputs.bucket_name }}
            AWS_REGION: ${{ inputs.aws_region }}
            ENVIRONMENT: ${{ inputs.environment }}

            # CIDR: ${{ inputs.cidr }}
            # AZS: ${{ inputs.azs }}
            # PUBLIC_SUBNETS: ${{ inputs.public_subnets }}
            # PRIVATE_SUBNETS: ${{ inputs.private_subnets }}

        steps:
            - name: Verify password
              run: |
                  if [ "$INPUT_PASSWORD" != "$DESTROY_PASSWORD" ]; then
                    echo "ERROR: Invalid destroy password!"
                    exit 1
                  fi
                  echo "Password verified. Proceeding with destroy..."

            - name: Checkout
              uses: actions/checkout@v4

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: "1.6.6"
# -------------------------------------------
#  INIT + DESYTROY VPC
# -------------------------------------------
            - name: Download tfvars from S3
              working-directory: ./micro-project/vpc
              run: |
                aws s3 cp \
                    s3://${BUCKET_NAME_BACKEND}/${ENVIRONMENT}/terraform.tfvars.json \
                    terraform.auto.tfvars.json
            - name: Terraform Init (with backend config)
              working-directory: ./micro-project/vpc
              run: |
                terraform init \
                    -backend-config="bucket=${BUCKET_NAME_BACKEND}" \
                    -backend-config="key=${ENVIRONMENT}/vpc/terraform.tfstate" \
                    -backend-config="region=${AWS_REGION}" \
                    -backend-config="encrypt=true"

            - name: Terraform Destroy
              working-directory: ./micro-project/vpc
              run: terraform destroy -auto-approve 